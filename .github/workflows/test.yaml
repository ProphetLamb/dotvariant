name: test
on: [push, pull_request]

defaults:
  run:
    shell: pwsh
    working-directory: src

jobs:
  cover-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: [Debug, Release]

    steps:
      - uses: actions/checkout@v2

      - run: dotnet test dotVariant.sln -p:Configuration=${{ matrix.config }}

  # Run dotVariant.Test against the locally built package instead of
  # ProjectReference. This ensures that both the generator
  # and the runtime library are packaged correctly.
  package-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - uses: nuget/setup-nuget@v1

      - name: Build package
        run: dotnet build dotVariant/dotVariant.csproj -p:Configuration=Release -p:PackageSelfTest=true

      - name: Install locally built package
        run: nuget sources add -name local -source dotVariant/bin/Release

      - name: Run consumer tests against package
        run: dotnet test dotVariant.Test/dotVariant.Test.csproj -p:Configuration=Debug -p:PackageSelfTest=true

